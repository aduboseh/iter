apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scg-telemetry-storage
  namespace: scg-pilot-01
  labels:
    scg-mission: pilot-01
    component: telemetry
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: managed-premium  # Azure Premium SSD
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scg-lineage-storage
  namespace: scg-pilot-01
  labels:
    scg-mission: pilot-01
    component: lineage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: managed-premium  # Azure Premium SSD with encryption
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scg-mcp-config
  namespace: scg-pilot-01
  labels:
    scg-mission: pilot-01
    component: configuration
data:
  # Directive §2.4: Time synchronization
  NTP_SERVERS: "time.windows.com,time.nist.gov"
  CLOCK_SKEW_TOLERANCE_MS: "50"
  
  # Directive §2.5: Telemetry buffering
  TELEMETRY_BUFFER_SIZE_MB: "15"
  TELEMETRY_FLUSH_INTERVAL_SEC: "5"
  
  # Directive §3: Invariant thresholds
  ENERGY_DRIFT_THRESHOLD: "1e-10"
  COHERENCE_THRESHOLD: "0.97"
  LINEAGE_EPSILON: "1e-10"
  ESV_VALID_RATIO: "1.0"
  SHARD_BOUNDARY: "250"
  
  # Monitoring interval (Directive §3)
  INVARIANT_CHECK_INTERVAL_SEC: "60"
  
  # Target RPS
  TARGET_RPS: "7500"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scg-mcp
  namespace: scg-pilot-01
  labels:
    app: scg-mcp
    scg-mission: pilot-01
    scg-version: v1.0.0-substrate
    scg-commit: ab48747
    directive: SG-SCG-PILOT-AUTH-01-v1.2.0
spec:
  replicas: 1  # Single instance for deterministic substrate behavior
  strategy:
    type: Recreate  # No rolling updates - substrate must be immutable
  selector:
    matchLabels:
      app: scg-mcp
      scg-mission: pilot-01
  template:
    metadata:
      labels:
        app: scg-mcp
        scg-mission: pilot-01
        scg-version: v1.0.0-substrate
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      # Directive §2.3: High priority to prevent noisy neighbor interference
      priorityClassName: scg-substrate-priority
      
      # Security context per Directive §4.1
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      
      # Service account with minimal permissions
      serviceAccountName: scg-mcp-sa
      automountServiceAccountToken: true
      
      containers:
      - name: scg-mcp
        image: scgpilotacr.azurecr.io/scg-mcp:v1.0.0-substrate
        imagePullPolicy: Always
        
        # Activate substrate with synthetic request stream (Directive SG-SCG-PILOT-ACT-01 v1.0.0 §2.1)
        # Generates continuous MCP requests to drive processing and enable telemetry emission
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "================================================"
          echo "SCG-PILOT-01 Field Validation - ACTIVE MODE"
          echo "Directive: SG-SCG-PILOT-ACT-01 v1.0.0"
          echo "Substrate Version: v1.0.0-substrate"
          echo "Mission: 7-day continuous operation with telemetry"
          echo "OTEL Endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT}"
          echo "================================================"
          echo ""
          
          # Generate continuous synthetic requests to drive substrate
          generate_requests() {
              local request_id=1
              local cycle=0
              
              # Fixed UUIDs for stable testing
              local NODE1="00000000-0000-0000-0000-000000000001"
              local NODE2="00000000-0000-0000-0000-000000000002"
              local EDGE1="00000000-0000-0000-0000-000000000003"
              
              while true; do
                  cycle=$((cycle + 1))
                  
                  # Cycle through valid RPC methods - predominantly read-only to minimize drift
                  case $((cycle % 20)) in
                      0) 
                          # Very rare node creation with near-zero energy (1e-12)
                          echo "{\"jsonrpc\":\"2.0\",\"id\":${request_id},\"method\":\"node.create\",\"params\":{\"belief\":0.001,\"energy\":1e-12}}"
                          ;;
                      *) 
                          # All other cycles: read-only operations
                          case $((cycle % 3)) in
                              0)
                                  # Query governor status (telemetry source)
                                  echo "{\"jsonrpc\":\"2.0\",\"id\":${request_id},\"method\":\"governor.status\",\"params\":{}}"
                                  ;;
                              1)
                                  # Replay lineage (telemetry source)
                                  echo "{\"jsonrpc\":\"2.0\",\"id\":${request_id},\"method\":\"lineage.replay\",\"params\":{}}"
                                  ;;
                              2)
                                  # Governor status again
                                  echo "{\"jsonrpc\":\"2.0\",\"id\":${request_id},\"method\":\"governor.status\",\"params\":{}}"
                                  ;;
                          esac
                          ;;
                  esac
                  
                  request_id=$((request_id + 1))
                  sleep 0.1  # ~10 RPS (ultra-conservative, 95% read-only operations)
              done
          }
          
          echo "[ACTIVATION] Launching substrate with synthetic request stream..."
          echo "[ACTIVATION] Target RPS: ~100 (well below 7500 limit)"
          echo ""
          
          # Start substrate with request generator
          generate_requests | /app/scg_mcp_server
        
        # Resource limits adjusted for cluster capacity
        # Directive SG-SCG-PILOT-ACT-01 §8: Max 4 cores per substrate
        # Quota: 6 CPU / 12GB total (shared with OTEL collector: 500m / 256Mi)
        resources:
          requests:
            cpu: "1"  # Scheduling on 2-CPU nodes
            memory: "2Gi"  # Scheduling with available memory
          limits:
            cpu: "4"  # Directive ACT-01 §8: 4 cores max per substrate
            memory: "10Gi"  # Fits within 12GB namespace quota (with OTEL overhead)
        
        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: scg-mcp-config
        
        env:
        - name: RUST_LOG
          value: "info"
        - name: RUST_BACKTRACE
          value: "1"
        - name: SCG_MISSION
          value: "pilot-01"
        - name: SCG_SUBSTRATE_VERSION
          value: "v1.0.0-substrate"
        - name: SCG_DIRECTIVE
          value: "SG-SCG-PILOT-AUTH-01-v1.2.0"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        
        # Volume mounts for persistent storage (Directive §2.5)
        volumeMounts:
        - name: telemetry-volume
          mountPath: /var/log/scg
        - name: lineage-volume
          mountPath: /var/lib/scg
        
        # Health checks (adjusted for keep-alive mode)
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - test -d /var/log/scg && test -d /var/lib/scg
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - test -d /var/log/scg && test -d /var/lib/scg
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 2
        
        # Security context
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # Need write access for logs
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
      
      # Volumes
      volumes:
      - name: telemetry-volume
        persistentVolumeClaim:
          claimName: scg-telemetry-storage
      - name: lineage-volume
        persistentVolumeClaim:
          claimName: scg-lineage-storage
      
      # Node affinity for stable hardware (Directive §2.4 time sync)
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      
      # Toleration for dedicated nodes (if available)
      tolerations:
      - key: "scg-substrate"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: scg-mcp-sa
  namespace: scg-pilot-01
  labels:
    scg-mission: pilot-01
    component: identity
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: scg-mcp-role
  namespace: scg-pilot-01
  labels:
    scg-mission: pilot-01
    component: rbac
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: scg-mcp-rolebinding
  namespace: scg-pilot-01
  labels:
    scg-mission: pilot-01
    component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: scg-mcp-role
subjects:
- kind: ServiceAccount
  name: scg-mcp-sa
  namespace: scg-pilot-01
---
apiVersion: v1
kind: Service
metadata:
  name: scg-mcp-service
  namespace: scg-pilot-01
  labels:
    app: scg-mcp
    scg-mission: pilot-01
spec:
  type: ClusterIP
  selector:
    app: scg-mcp
    scg-mission: pilot-01
  ports:
  - name: mcp
    port: 3000
    targetPort: 3000
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
