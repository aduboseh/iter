name: Connectome Zero-Coupling Audit

on:
  pull_request:
    paths:
      - 'src/connectome/**'
  push:
    branches:
      - 'connectome/**'
      - 'main'
    paths:
      - 'src/connectome/**'

jobs:
  audit_coupling:
    runs-on: ubuntu-latest
    name: Verify Zero Substrate Coupling

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for forbidden substrate imports
        run: |
          echo "=== Connectome Zero-Coupling Audit ==="
          echo "Scanning src/connectome/ for substrate imports..."
          
          FORBIDDEN_PATTERNS=(
            "use crate::scg_core"
            "use crate::types::"
            "use crate::fault::"
            "use crate::telemetry::"
            "use crate::lineage::"
            "use super::super::scg_core"
            "use super::super::types"
            "use super::super::fault"
            "use super::super::telemetry"
            "use super::super::lineage"
            "use crate::mcp_handler::[^M]"  # Allow MCP client types only
          )
          
          VIOLATIONS=0
          
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            if grep -r -n "$pattern" src/connectome/ ; then
              echo "❌ VIOLATION: Found forbidden import: $pattern"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "❌ CONNECTOME COUPLING AUDIT FAILED"
            echo "========================================"
            echo "Found $VIOLATIONS forbidden substrate imports in src/connectome/"
            echo ""
            echo "Connectome v2 MUST maintain zero coupling to substrate internals."
            echo "All substrate interaction must occur via MCP protocol only."
            echo ""
            echo "Allowed imports:"
            echo "  - std::*"
            echo "  - External crates (serde, tokio, etc.)"
            echo "  - super::* (within connectome modules)"
            echo "  - crate::connectome::*"
            echo ""
            echo "Forbidden imports:"
            echo "  - crate::scg_core::*"
            echo "  - crate::types::*"
            echo "  - crate::fault::*"
            echo "  - crate::telemetry::*"
            echo "  - crate::lineage::*"
            echo ""
            echo "See: CONNECTOME_V2_SCAFFOLD.md §3.1 Isolation Contract"
            echo "See: LTS_STRATEGY.md §3.3 Substrate Compatibility"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "✅ CONNECTOME COUPLING AUDIT PASSED"
          echo "Zero substrate coupling verified."

      - name: Check connectome compiles independently
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Verify connectome builds
        run: |
          echo "=== Connectome Independent Build Test ==="
          cargo build --lib --release
          
          if [ $? -ne 0 ]; then
            echo "❌ Connectome build failed"
            exit 1
          fi
          
          echo "✅ Connectome builds successfully"

      - name: Run connectome tests
        run: |
          echo "=== Connectome Test Suite ==="
          cargo test --lib --release -- connectome
          
          if [ $? -ne 0 ]; then
            echo "❌ Connectome tests failed"
            exit 1
          fi
          
          echo "✅ All connectome tests passing"

      - name: Generate coupling report
        run: |
          echo "=== Connectome Coupling Report ==="
          echo ""
          echo "Connectome Version: v2.0.0-alpha"
          echo "Substrate Compatibility: v1.0.x-substrate"
          echo ""
          echo "Modules Audited:"
          ls -la src/connectome/
          echo ""
          echo "Coupling Status: ZERO (verified)"
          echo "MCP Protocol: EXCLUSIVE interface"
          echo ""
          echo "Certification: ISOLATED ARCHITECTURE CONFIRMED"
