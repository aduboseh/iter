# MCP Integration Test Suite CI
# Validates MCP boundary sanitization on every PR
#
# Build Modes:
# - Public CI (default): Uses public_stub feature, no proprietary dependencies
# - Full substrate: Requires SCG_PAT secret and private repo access

name: MCP Integration Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  ITER_DETERMINISM: "1"
  # Public CI uses stub mode by default
  CARGO_FEATURES: "--no-default-features --features public_stub"

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-v2-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-v2-${{ hashFiles('**/Cargo.lock') }}

      - name: Build in public_stub mode
        run: |
          echo "Building with: $CARGO_FEATURES"
          cargo build --release $CARGO_FEATURES

      - name: Run lib tests (public_stub)
        run: |
          cargo test --lib --release $CARGO_FEATURES

      - name: Run governance invariant tests
        run: |
          echo "ðŸ”’ Running governance invariant tests..."
          cargo test --test governance_invariants --release $CARGO_FEATURES
          echo "âœ… Governance invariants passed"

      # NOTE: Sanitizer/integration tests require full_substrate and run locally only

      - name: Verify build produces valid binary
        run: |
          # Verify the stub server binary exists and responds
          cargo build --release --bin iter-server $CARGO_FEATURES
          echo "âœ… iter-server binary built successfully in public_stub mode"

      - name: Check for substrate imports in handler
        run: |
          # Ensure mcp_handler does not directly expose substrate internals
          if grep -E "adjacency|dag_topology|esv_raw|energy_matrix" src/mcp_handler.rs; then
            echo "::warning::mcp_handler.rs may expose substrate internals - verify sanitization"
          fi

      - name: Validate response baseline snapshot
        run: |
          if [ -f tests/snapshots/response_baseline.json ]; then
            python3 -c "import json; json.load(open('tests/snapshots/response_baseline.json'))"
            echo "âœ… Response baseline snapshot is valid"
          else
            echo "::warning::Response baseline snapshot not found"
          fi

  boundary-audit:
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
      - uses: actions/checkout@v4

      - name: Audit forbidden patterns in codebase
        run: |
          echo "ðŸ” Auditing for forbidden pattern exposure..."
          
          # Check for forbidden patterns in response construction
          forbidden_patterns=(
            "dag_topology"
            "adjacency_matrix"
            "esv_raw"
            "energy_matrix"
            "lineage_hash_chain"
            "internal_state"
          )
          
          violations=0
          for pattern in "${forbidden_patterns[@]}"; do
            # Search in src/ excluding sanitizer module (which defines the patterns)
            matches=$(grep -r "$pattern" src/ --include="*.rs" | grep -v "sanitizer" | grep -v "FORBIDDEN_PATTERNS" || true)
            if [ -n "$matches" ]; then
              echo "âš ï¸  Found '$pattern' outside sanitizer:"
              echo "$matches"
              # This is a warning, not a failure - patterns may be used in comments or for filtering
            fi
          done
          
          echo "âœ… Boundary audit complete"

      - name: Check sanitizer module exists
        run: |
          echo "ðŸ“Š Verifying sanitizer module structure..."
          # Sanitizer module exists (full_substrate only, but structure is present)
          if [ -d "src/services/sanitizer" ]; then
            echo "âœ… Sanitizer module present"
          else
            echo "::warning::Sanitizer module not found (expected for full_substrate)"
          fi

  stability-verification:
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
      - uses: actions/checkout@v4

      - name: Verify no CRLF line endings
        run: |
          echo "ðŸ” Checking for CRLF line endings..."
          if grep -rIl $'\r' --include="*.rs" --include="*.md" --include="*.toml" --include="*.yml" --include="*.yaml" --include="*.json" . 2>/dev/null; then
            echo "::error::CRLF detected â€” line ending drift invalidates SHA256 checksums"
            exit 1
          fi
          echo "âœ… Line endings OK (LF only)"

      - name: Verify stability baseline exists
        run: |
          echo "ðŸ”’ Verifying stability baseline integrity..."
          if [ ! -f audits/stability_v0.2.0/repo_manifest.sha256 ]; then
            echo "::error::Stability baseline manifest missing"
            exit 1
          fi
          if [ ! -f audits/stability_v0.2.0/timestamp.txt ]; then
            echo "::error::Stability baseline timestamp missing"
            exit 1
          fi
          echo "âœ… Stability baseline v0.2.0 verified"

  governance-invariants:
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-v2-${{ hashFiles('**/Cargo.lock') }}

      - name: Run governance invariant tests
        env:
          CARGO_FEATURES: "--no-default-features --features public_stub"
        run: |
          echo "ðŸ”’ Running governance invariant tests..."
          cargo test --test governance_invariants --release $CARGO_FEATURES -- --test-threads=1
          echo "âœ… All governance invariants passed"

  merge-gate:
    runs-on: ubuntu-latest
    needs: [integration-tests, boundary-audit, stability-verification, governance-invariants]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "::error::Integration tests failed. Merge blocked."
            exit 1
          fi
          if [ "${{ needs.governance-invariants.result }}" != "success" ]; then
            echo "::error::Governance invariant tests failed. Merge blocked."
            exit 1
          fi
          if [ "${{ needs.stability-verification.result }}" != "success" ]; then
            echo "::error::Stability verification failed. Merge blocked."
            exit 1
          fi
          echo "âœ… All checks passed. Ready for merge."
